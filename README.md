# Princessify

プリコネR（プリンセスコネクト! Re:Dive）のクランバトル向け Discord Bot です。
TL（タイムライン）のお団子状態を可視化し、同時凸の持ち越し計算もできます。

## 機能

### 1. お団子カラーリング

ユーザーが書いたお団子（SET ON/OFF 状態）を読み取り、**前の行からの変化を色付け**して見やすくします。

```
-dango

1:30 開始 [〇〇〇〇〇]
1:20 キャル [〇〇❌❌ー]
1:10 ヴァンピィ [ーーーーー]
```

- 括弧の種類（`[]【】()` 等）や ON/OFF 文字の表記揺れ（`OoXx-ー❌` 等）を自動で統一
- オート切替があれば 👉✅(ON) / 👉⬛(OFF) を表示

### 2. お団子自動推論

入力にお団子がない場合、**SET ON/OFF タイミングを自動で推論**します。

```
-dango エリス エキドナ ネネカ キャル ヴァンピィ

1:17 キャル 秒数最速 #エイドcl
1:10 ヴァンピィ #通常cl
1:04 キャル #通常cl
1:02 ヴァンピィ AUTO ここでネネカset
1:00 キャル エイドcl最速
```

- `#` 付き → SET UB（直前行に⭕、発動行に❌を自動配置）
- `AUTO` → オート切替（👉✅ / 👉⬛）
- `ここで〇〇set` → 明示的 SET 指示
- 手動 UB → 🌟 マーカー付与
- 初期行 `1:30 開始 [❌❌❌❌❌]` を自動生成

### 3. 同時凸の持ち越し時間計算

同時凸した場合の持ち越し秒数を、有効な全組み合わせから算出しランキング表示します。

```
-mochi 5 3 2.5
```

- 持ち越し秒数が大きい順にランキング表示
- 3人以上の同時凸にも対応（部分参加パターンも自動検出）
- `ダメージ:@名前` でラベル付け可能
- `ダメージ*` で持ち越し消化中メンバーの〆除外

## チャンネルモード

`/dango add` でチャンネルを登録すると、`-dango` なしで TL が自動処理されます。

| コマンド | 説明 |
|---------|------|
| `/dango add` | チャンネルを監視対象に追加 |
| `/dango remove` | チャンネルを監視対象から削除 |
| `/dango list` | サーバー内の監視チャンネル一覧 |

## セットアップ

### 必要なもの

- Node.js 18+
- Discord Bot トークン

### 起動手順

```bash
git clone https://github.com/sloom/princessify.git
cd princessify
npm install
cp .env.example .env   # DISCORD_TOKEN を設定
npm run dev
```

### 環境変数

| 変数 | 説明 |
|------|------|
| `DISCORD_TOKEN` | Discord Bot トークン（必須） |
| `CHANNEL_ID` | 初期監視チャンネル ID（カンマ区切り、任意） |
| `PORT` | ヘルスチェック用ポート（デフォルト: 3000） |

## 開発

```bash
npm test              # テスト実行
npm run build         # TypeScript ビルド
npx tsc --noEmit      # 型チェックのみ
```

## ライセンス

ISC
